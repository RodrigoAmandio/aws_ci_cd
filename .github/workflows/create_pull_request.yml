# A criação do PR request deve ser um workflow separado do CI
# Isso ocorre para que as alterações locais sejam enviadas definitivamente ao repositório remoto
# Posteriormente, o PR pode ser criado
name: Create Pull Request

on:
  workflow_run:
    workflows: ["CI Checking"] # Dispara este workflow assim que o workflow de CI for concluído
    types:
      - completed

jobs:
  create-pr:
    # Executa este job somente se o workflow de CI tiver sido concluído com sucesso
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # Etapa 1: Buscar o nome da branch que originou o workflow de CI e exportar como variável
      - name: Obter informações do workflow de origem
        id: get_workflow_info
        run: |
          echo "Buscando detalhes do workflow que disparou este..."
          # Usa a API do GitHub para obter a branch de origem do workflow de CI
          gh api \
            /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} \
            --jq '.head_branch' > branch.txt

          # Lê o nome da branch e define como saída para ser reutilizado
          BRANCH_NAME=$(cat branch.txt)
          echo "head_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Etapa 2: Fazer checkout da branch original (a branch que iniciou o CI)
      - name: Checkout da branch de origem
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_workflow_info.outputs.head_branch }}
          fetch-depth: 0

      # Etapa 3: Autenticar a CLI do GitHub para poder executar comandos como criar PR
      - name: Autenticar CLI do GitHub
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # Etapa 4: Verificar se já existe um PR desta branch para a branch develop
      - name: Verificar se PR já existe
        id: check_pr
        run: |
          BRANCH_NAME="${{ steps.get_workflow_info.outputs.head_branch }}"

          # Verifica se já existe um PR com head = BRANCH_NAME e base = develop
          if gh pr view --head "$BRANCH_NAME" --base develop --json url > pr.json 2>/dev/null; then
            echo "PR já existe."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "PR ainda não existe."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Etapa 5: Criar o PR apenas se ele ainda não existir com as aspas em todos os valores que podem conter caracteres especiais
      - name: Criar Pull Request (caso não exista)
        if: steps.check_pr.outputs.exists == 'false'
        shell: bash
        run: |
          BRANCH_NAME="${{ steps.get_workflow_info.outputs.head_branch }}"

          echo "Branch: [$BRANCH_NAME]"
          
          echo "Criando PR da branch: $BRANCH_NAME para develop"

          gh pr create \
            --base "develop" \                          # Branch de destino
            --head "$BRANCH_NAME" \                     # Branch de origem
            --title "PR automático: $BRANCH_NAME" \
            --body "Este PR foi criado automaticamente após os testes passarem."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
